!function(){"use strict";define(["angular","utility"],function(e,t){var a=e.module("marketplace.MedsService",[]);a.factory("medsService",["navConstantsSvc","apiProvider","$sce","authService","$state","localStorageService","$rootScope","$http","notify","$window",function(e,t,a,n,r,i,s,o,d,c){var u=function(e){i.set("medsCartId",e)},p=function(){return i.get("medsCartId")||null},m=function(){i.remove("medsCartId")},l=function(){var e=n.removeMedsLocalCart();return m(),i.remove("patientId"),e},g=function(e,a,r){var s=t.medsService+"app/cart/item/"+a,d=n.isUserSignedin();return new Promise(function(t,c){if(d){var m={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:d.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:d.userDetails.phone,name:d.userDetails.username,timezone:"Asia/Kolkata",language:"English"};k(m).then(function(a){return o.post(s,{masterDrugCode:e,patientId:a,prePaymentCartId:p(),pincode:parseInt(n.getPincode())},{headers:{"content-type":"application/json; charset=UTF-8",source:"web",platform:"WEB",mbservertoken:d.encryptedToken}}).then(function(e){return r.count=e.data.message.itemQuantity,e.data.error?e.data.error:(i.set("medsCart",e.data.message.items),u(e.data.message.prePaymentCartId),void t(e.data.message))})["catch"](function(e){return e})})}else{var l={};l.cart={};var g=i.get("medsCart"),v=g.findIndex(function(e){return r.drugCode==e.drugCode});"add"==a?v>-1?(g[v].count+=1,r.count=g[v].count):(r.count+=1,g.push({drugCode:e,count:1}),v=g.findIndex(function(t){return e==t.drugCode})):"remove"==a&&v>-1&&(g[v].count<=1?(g.splice(v,1),r.count=0):(g[v].count-=1,r.count=g[v].count)),l.cart.items=g,l.masterDrugCode=e,l.itemQuantity=r.count||0,i.set("medsCart",g),t(l)}})},v=function(e){var t=b(),a=0;return t&&0!=t.length||e.forEach(function(e){e.count=0}),_.forEach(t,function(t){var n=e.findIndex(function(e){return e.drugCode==t.drugCode});n!=-1&&(e[n].count=t.count||t.addedQuantity),a=t.count||t.addedQuantity||t.length||0}),{meds:e,cartQuantity:a}},f=function(e,t,a){e.findIndex(function(e){return t==e.drugCode});return s.$apply(),e},h=function(){if(i.get("medsCartId"))l(),d({message:"Items in the Cart are removed",position:"center",duration:5e3}),r.go("app.medicine",{categoryItemTypeId:"Medicine"});else{var e=i.get("medsCart");if(e&&e.length>0){const a=e.map(function(e){var t=e.drugCode,a=e.count,n=e.addedQuantity;return{quantity:a||n,drugCode:t}});var s=n.isUserSignedin(),c=t.medsService+"app/cart/addItemBulk";return new Promise(function(e,t){k({device:"WEB",version:"10",appversion:"v3.2.19_dev",email:s.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:s.userDetails.phone,name:s.userDetails.displayName,timezone:"Asia/Kolkata",language:"English"}).then(function(t){n.getuserLongToken(s.token).then(function(n){o.post(c,{drugCodes:a,patientId:t,pincode:560076},{headers:{"content-type":"application/json; charset=UTF-8",source:"web",mbservertoken:s.encryptedToken||n.data.encryptedToken}}).then(function(t){i.set("medsCart",t.data.message.items),u(t.data.message.prePaymentCartId),e(t.data.message)})["catch"](function(t){e(t)})})})})}}},b=function(){const e=i.get("medsCartId");var a=t.medsService+"app/cart/"+e+"?pincode="+n.getPincode(),r=n.isUserSignedin();return new Promise(function(t,n){return r&&e?o.get(a,{headers:{"content-type":"application/json; charset=UTF-8",source:"web",mbservertoken:r.encryptedToken}}).then(function(e){i.set("medCart",e.data.message.items),t(e.data.message)})["catch"](function(e){}):void t(i.get("medsCart"))})},y=function(e){var t=JSON.parse(JSON.stringify(e.searchData));"UPLOADRX"==e.searchData.additionalParams.meta.type&&1!=e.isReOrder&&u(0);var a=p(),n={addressCity:"Banglore",addressLine:t.addressLine1,deliveryType:e.storeData?"store_pickup":"home_delivery",email:t.email,gender:"M"===t.gender?"Male":"Female",isRxUpload:"UPLOADRX"==e.searchData.additionalParams.meta.type||"REORDER"==e.searchData.additionalParams.meta.type,maid:e.appointmentData&&e.appointmentData.maid?String(e.appointmentData.maid):"0",meta:t.additionalParams.meta,packageName:t.packageName,patientDetails:{firstName:t.patientName.split(" ")[0],lastName:t.patientName.split(" ").length>1?t.patientName.split(" ")[t.patientName.split(" ").length-1]:""},bookingSource:"web",patientId:i.get("patientId"),paymentMode:"COD",phoneNumber:t.phone,pickupStoreID:e.storeData.storeID,pincode:t.pincode.toString(),prePaymentCartId:a?a:0,prescriptionFilePaths:[],relation:t.relation,retainCoupon:!1,storeAddress:e.storeData.address,uploadedFiles:t.uploadedFiles,ailment:t.ailment||""};return e.checkoutData=n,i.set("checkoutData",e.checkoutData),n},k=function(e){var a=(i.get("patientId"),t.medsService+"app/authenticate/medibuddyUser"),r=n.isUserSignedin();return new Promise(function(t,s){n.getuserLongToken(r.token).then(function(n){o.post(a,e,{headers:{advertiserid:"898503d6-9c78-4248-b915-52e2bf527385","content-type":"application/json",mbappversioncode:"509",mbappversionname:"3.2.19_dev",mbservertoken:r.encryptedToken||n.data.encryptedToken,newrelic:"{v:[0,2],d:{d.ty:Mobile,d.ac:,d.ap:,d.tr:2b7cb8f24ec3474e88b796c2c1f5cdb4,d.id:fee4dbe33c414009,d.ti:1662553963298}}",source:"AndroidMB",traceparent:"00-2b7cb8f24ec3474e88b796c2c1f5cdb4-fee4dbe33c414009-00",tracestate:"@nr=0-2---fee4dbe33c414009----1662553963298",type:"search"}}).then(function(e){i.set("patientId",e.data.message.patientId),t(e.data.message.patientId)})["catch"](function(e){return e})})})},C=function(e){var a=t.medsService+"app/cart/checkout",r=n.isUserSignedin();return new Promise(function(t,n){if(r){var i={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:r.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:r.userDetails.phone,name:r.userDetails.username,timezone:"Asia/Kolkata",language:"English"};k(i).then(function(n){return e.patientId=n,o.post(a,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:r.encryptedToken,useraccesstoken:""}}).then(function(e){e.data.error&&t(e.data),t(e.data.message)})["catch"](function(e){t("")})})}})},P=function(e,a){var r=t.medsService+"app/cart/removeCoupon",i=n.isUserSignedin(),s=y(a);return s.bookingSource="web",e=Object.assign(e,{walletRequest:s}),new Promise(function(t,a){o.post(r,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:i.encryptedToken,useraccesstoken:""}}).then(function(e){t(e.data.message)})})},I=function(e,a){var r=t.medsService+"app/cart/changeWallet",i=n.isUserSignedin(),s=y(a);return s.bookingSource="web",e=Object.assign(e,{walletRequest:s}),new Promise(function(t,a){o.post(r,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:i.encryptedToken,useraccesstoken:""}}).then(function(e){t(e.data.message)})["catch"](function(e){console.error("catch -> changeWallet",e.data.errMessage,e.data.errMessage.stack),t("")})})},S=function(e,a){var r=t.medsService+"app/cart/addCoupon",i=n.isUserSignedin(),s=y(a);return s.bookingSource="web",e=Object.assign(e,{walletRequest:s}),new Promise(function(t,a){o.post(r,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:i.encryptedToken,useraccesstoken:""}}).then(function(e){t(e.data.message)})})},D=function(e,a){var r=t.medsService+"app/medibuddyPaymentMethod",i=n.isUserSignedin();return new Promise(function(t,n){o.post(r,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:i.encryptedToken,useraccesstoken:"",newCheckout:!0,accessToken:a}}).then(function(e){e.error?(console.log(e.errMessage),t(e.errMessage)):t(e.data.message)})})},w=function(a,i,s,p){l();var m=t.medsService+"app/reorder/"+a,g=n.isUserSignedin();return new Promise(function(a,l){var v={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:g.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:g.userDetails.phone,name:g.userDetails.username,timezone:"Asia/Kolkata",language:"English"};k(v).then(function(l){var v={pincode:parseInt(i),patientId:parseInt(l)};return o.post(m,v,{headers:{"content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:g.encryptedToken,useraccesstoken:"",newCheckout:!0}}).then(function(o){if(o.data.message.error)d({message:o.data.message.error,position:"center",duration:5e3}),console.log(o.data.message.error),a(o.data.message.error);else{if(u(o.data.message.prePaymentCartId),o.data.message.fileUploadedList.length>=0){var m={sessionData:{},forceUpdate:!0};n.medsReoderFiles=o.data.message.fileUploadedList;var l={fileArrays:JSON.stringify(o.data.message.fileUploadedList)};m.sessionData[e.medicineId]=JSON.stringify(l),n.makeAjaxCalls(t.apiUrl+"/SessionStorage.json",m,"POST",g.token).then(function(e){e.data.isSuccess}),o.data.message.items.length>0?(c._MB_Analytics.__push({isCleverTap:!0,isGoogle:!1,name:"DigitisedCart",payload:c._Site_Props.__getEventParameters({service:!0,custom:{}})}),r.go("app.medicineCart",{medicine:"Medicines",pincode:i,reorder:!0},{reload:"app.medicineCart"})):p||(c._MB_Analytics.__push({isCleverTap:!0,isGoogle:!1,name:"NonDigitisedCart",payload:c._Site_Props.__getEventParameters({service:!0,custom:{}})}),r.go("app.medicine",{city:s,pincode:i},{reload:"app.medicine"}))}a(o.data.message)}})["catch"](function(e){console.log(e)})})})};return{reorder:w,updateItemOfCart:g,addBulkItemToCart:h,removeCartId:m,removeMedsCart:l,getCart:b,getCartId:p,updateUiOnReload:v,updateUi:f,checkoutData:y,getPatientId:k,checkout:C,removeCouponV2:P,changeWallet:I,addCoupon:S,payment:D,updateCartId:u}}])})}();