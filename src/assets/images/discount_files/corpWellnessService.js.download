!function(){"use strict";define(["angular","utility"],function(e,a){var t=e.module("marketplace.CorpWellnessService",[]);t.factory("corpWellnessService",["$state","navConstantsSvc","apiProvider","localStorageService","authService","$rootScope","$http",function(t,r,i,o,s,n,c){function p(e){return _.filter(e,function(e){return e.minAge&&(e.minAge=parseInt(e.minAge)),e.maxAge&&(e.maxAge=parseInt(e.maxAge)),e=d(e),e.isCovid=e.packageName.toLowerCase().indexOf("covid")>-1,!(e.packageName.toLowerCase().indexOf("wellness coach")>-1)||(u.push(e.packageId),!1)})}function d(e){return"M"==e.gender||"Male"==e.gender?(e.iconUrl="/assets/icons/male-user",e.genderType="M"):"F"==e.gender||"Female"==e.gender?(e.iconUrl="/assets/icons/female-user",e.genderType="F"):e.iconUrl="/assets/icons/profile",e.labtests=[],e.consultations=[],_.each(e.investigations,function(a){"Consultation"==a.groupName||"Core_Consultation"==a.typeName?e.consultations.push(a):("Others"!=a.groupName||e.covidTest||(e.covidTest=_.contains(r.covidPackageList,a.name)),"Core_Profile"!=a.typeName&&e.labtests.push(a))}),e}var l=[],g=r.topCities;Date.prototype.addDays=function(e){return this.setDate(this.getDate()+parseInt(e)),this};var u=[],k=function(t,o){var d=new Promise(function(d,l){var g=s.isUserSignedin()||{},k={};s.makeAjaxCalls(i.apiUrl+"/AHC/GetPackagesForCorporate",t,"POST",g.token,"",o).then(function(t){if(t.data.isSuccess){var o=s.isUserSignedin();if(o&&o.corpConfig){k.corpConfig=o.corpConfig,n.corpConfig=_.pick(k.corpConfig,"suggestLabtest");var P=k.corpConfig.corporateLogo;!P&&g&&g.userDetails&&(P="/static/corpLogo/"+g.userDetails.pmEntityID+".png"),P&&c.get(i.staticUrl.slice(0,-1)+P.slice(7,P.length),{responseType:"blob"}).then(function(e){var a=new FileReader;a.readAsDataURL(e.data),a.onload=function(e){n.corpConfig.corporateLogo=e.target.result}})}t.data.serverDate&&(s.serverDate=parseInt(t.data.serverDate.replace("/Date(","")));var f=p(t.data.ahcPackages),v=_.groupBy(f,"packageId");k.ahcPackages=t.data.ahcPackages,k.employeeDetail=t.data.employeeDetail,k.pmEntityID=t.data.pmEntityId,k.accessToken=t.data.accessToken,k.isSponseredBook=t.data.isSponseredBook,_.each(k.employeeDetail.beneficiaries,function(r){_.isEmpty(u)||(r.sponsPackage=_.reject(r.sponsPackage,function(e){return _.contains(u,e)}),r.paidPackage=_.reject(r.paidPackage,function(e){return _.contains(u,e)})),r.genderFilter={type:r.gender,isTrue:!0},r.maxAge=r.age,r.minAge=0;var i=e.copy(r);if(!_.isEmpty(r.sponsPackage)){i.isSponsored=!0,i.price=0,r.sponsPackageIds=r.sponsPackage;var o=e.copy(v);r.sponsPackage=_.map(r.sponsPackage,function(e){return o[e]?(a.getFlatProperty(k,"configuration.displaySponsoredPrice")||(o[e][0].price=0),_.omit(_.extend(i,o[e][0]),"paidPackage","sponsPackage")):null})}if(r.sponsPackage=_.filter(r.sponsPackage,function(e){return e}),t.data.packagePriceDetail&&(s.corporatePackages.corporatePricing=_.groupBy(t.data.packagePriceDetail,"maid")),!_.isEmpty(r.paidPackage)){var n=s.corporatePackages.corporatePricing?s.corporatePackages.corporatePricing[r.maid]:[];i.isSponsored=!1,r.paidPackageIds=r.paidPackage,r.paidPackage=_.map(r.paidPackage,function(e){if(v[e]){if(n[0]&&!_.isEmpty(n[0].packagePrice)){var a=n[0].packagePrice.find(function(a){return a.packageId===e});a&&(v[e][0].price=a.price)}return _.omit(_.extend(i,_.omit(v[e][0],"minAge","maxAge")),"paidPackage","sponsPackage")}return null}),r.paidPackage=_.filter(r.paidPackage,function(e){return e})}"self"==r.relationName.toLowerCase()&&(k.primaryPackage=r)}),k.sponsoredPackages=_.flatten(_.compact(_.pluck(k.employeeDetail.beneficiaries,"sponsPackage"))),k.paidPackages=_.flatten(_.compact(_.pluck(k.employeeDetail.beneficiaries,"paidPackage"))),k.packageIds=_.pluck(f,"packageId"),_.forEach(k.sponsoredPackages,function(e){_.isUndefined(e.relationId)&&(e.relationId="Self"==e.relationName?0:1)}),s.corporatePackages.homeVisitPackages=[],s.corporatePackages.centerVisitPackages=[],k.packageIds=[],_.forEach(f,function(e){k.packageIds.push(e.packageId),e.isHomeSampleOnlyPackage?s.corporatePackages.homeVisitPackages.push(e):s.corporatePackages.centerVisitPackages.push(e)}),s.corporatePackages.paidPackages=k.paidPackages,s.corporatePackages.ahcPackages=f,k.sponsoredPackages=_.sortBy(k.sponsoredPackages,"relationId"),s.corporatePackages.sponsoredPackages=_.sortBy(k.sponsoredPackages,function(e){return!e.isHomeSampleOnlyPackage}),s.corporatePackages.employeeDetail=k.employeeDetail,d(k),window._Site_Props.__setServiceDetails({serviceName:r.ahcFilterName,serviceType:"UCP"})}else{var m=new Error(t.data.errorMessage);l(m)}},function(e){e.message="It is taking longer than usual, please reload the page or try again later.",l(e)})});return d},P=function(e,t){var r=new Promise(function(r,o){var n={},c=s.isUserSignedin();s.makeAjaxCalls(i.apiUrl+"/AddBeneficiary",e,"POST",c.token,"",t).then(function(t){if(t.data.isSuccess&&t.data.vasBenefId)if(_.isEmpty(t.data.ahcPackages))n.noMatch=!0,r(n);else{var i=p(t.data.ahcPackages),c=_.isEmpty(t.data.packagePriceDetail)?[]:t.data.packagePriceDetail[0].packagePrice;if(1===i.length){var d=a.calculateAge(e.dob,s.serverDate),l={maid:t.data.vasBenefId,relationName:e.relationName,isSponsored:!1,gender:e.gender,name:e.name,age:d,genderFilter:{isTrue:!0,type:e.gender},maxAge:d,minAge:0,iconUrl:"M"==e.genderType?"/assets/icons/male-user":"/assets/icons/female-user",showAddon:!1,showDetails:!1,isAddedToCart:!1},g=c.find(function(e){return e.packageId==i[0].packageId});g&&(i[0].price=g.price),n.packageAdded=Object.assign(l,i[0]),s.corporatePackages.paidPackages.unshift(n.packageAdded)}else i.forEach(function(r){var i=a.calculateAge(e.dob,s.serverDate),o={maid:t.data.vasBenefId,relationName:e.relationName,isSponsored:!1,gender:e.gender,name:e.name,age:i,genderFilter:{isTrue:!0,type:e.gender},maxAge:i,minAge:0,iconUrl:"M"==e.genderType?"/assets/icons/male-user":"/assets/icons/female-user",showAddon:!1,showDetails:!1,isAddedToCart:!1},n=c.find(function(e){return e.packageId==r.packageId});n&&(r.price=n.price);var p=Object.assign(o,r);s.corporatePackages.paidPackages.unshift(p)});n.maidAdded=t.data.vasBenefId,r(n)}else o({errorMessage:t.errorMessage})},function(e){o()})});return r},f=function(e,a,t){var r=s.isUserSignedin(),o=30,n=s.corporatePackages.providers.map(function(e){return e.dcId?parseInt(e.dcId):0}),c={ContractId:9716,ProviderIds:[],NoOfDays:o,pmEntityId:r.userDetails.pmEntityID,IsHomeVisitCase:!0,packageIds:[e.packageId],pincode:parseInt(a)},p=new Promise(function(a,r){var o={};s.makeAjaxCalls(i.apiUrl+"/AHC/ProvidersWithCalendar",c,"POST").then(function(r){console.log(r),r.data.slotDetails&&(s.serverDate=parseInt(r.data.slotDetails.serverDate.replace("/Date(","")));var i=[],c=new Object;c.providerId=t,_.forEach(r.data.unionOfSlots,function(e,a){r.data.unionOfSlots[a].providerId=t}),c.daySlots=r.data.unionOfSlots,i.push(c),console.log(i),e.providerSlots=i,e.availableSlots=r.data.slotDetails.availableCalendarDays,s.corporatePackages.packageDetail=e;var p=_.pluck(r.data.slotDetails.providerSlots,"providerId");o.providers=_.filter(s.corporatePackages.providers,function(e){return e.isAutoSlotAvailable=_.contains(p,parseInt(e.dcId)),e.noAutoSlotAvailable=e.isAutoSlotAvailable?0:1,_.contains(n,parseInt(e.dcId))}),_.isEmpty(s.corporatePackages.blockDates)||_.each(e.providerSlots,function(e){s.corporatePackages.blockDates[e.providerId]&&_.each(s.corporatePackages.blockDates[e.providerId],function(a){var t=_.find(e.slots,function(e){return e.date==a.blockDate});t&&(t.availableSlots=0)})}),a(o)},function(e){r()})});return p},v=function(e){var a=s.isUserSignedin(),t=s.corporatePackages.providers.filter(function(e){return e.dcCity==s.getCity()}).map(function(e){return e.dcId?parseInt(e.dcId):0}),i={ProviderIds:_.uniq(t),pmEntityId:a.userDetails.pmEntityID,NoOfDays:30,ContractId:r.ahcContract,IsHomeVisitCase:e.isHomeSampleOnlyPackage,packageIds:s.corporatePackages.packageDetail?[s.corporatePackages.packageDetail.packageId]:[]},o=new Promise(function(a,t){var r={};s.makeAjaxCalls("https://www.medibuddy.in/WAPI/Labs/ProvidersCalendar",i,"POST").then(function(t){t.data.serverDate&&(s.serverDate=parseInt(t.data.serverDate.replace("/Date(",""))),e.providerSlots=t.data.providerSlots,e.availableSlots=t.data.availableCalendarDays,s.corporatePackages.packageDetail=e;var o=_.pluck(t.data.providerSlots,"providerId");r.providers=_.filter(s.corporatePackages.providers,function(e){return e.isAutoSlotAvailable=_.contains(o,parseInt(e.dcId)),e.noAutoSlotAvailable=e.isAutoSlotAvailable?0:1,_.contains(i.ProviderIds,parseInt(e.dcId))}),_.isEmpty(s.corporatePackages.blockDates)||_.each(e.providerSlots,function(e){s.corporatePackages.blockDates[e.providerId]&&_.each(s.corporatePackages.blockDates[e.providerId],function(a){var t=_.find(e.slots,function(e){return e.date==a.blockDate});t&&(t.availableSlots=0)})}),a(r)},function(e){t()})});return o},m=function(e,a){var t=s.isUserSignedin(),r=new Promise(function(r,o){var n={};_.each(e.beneficiaries,function(e){a.ahcBookingeDetails.push({maid:e.maid,PackageIds:e.paidPackageIds||e.sponsPackageIds})}),t.userDetails&&(a.pmEntityID=t.userDetails.pmEntityID),s.makeAjaxCalls(i.apiUrl+"/AHC/GetPriceForPackage",a,"POST").then(function(e){e.data.isSuccess?(n.groupedPackagePrice=_.groupBy(e.data.packagePriceDetail,"maid"),r(n)):o(e.data)})});return r},D=function(e,a){var t=s.isUserSignedin(),r=new Promise(function(r,o){var n={};if(a&&t){var c={packageId:e,employeeId:t.corpDetails.iwpEmployeeId,maid:t.userDetails.maid};s.makeAjaxCalls(i.apiUrl+"AHC/PackageDetails",c,"POST",t.token,s.getCity()).then(function(e){e.data.packageDetail?(e.data.serverDate&&(s.serverDate=parseInt(e.data.serverDate.replace("/Date(",""))),n.packageDetail=e.data.packageDetail,r(n)):o()})}else s.makeAjaxCalls(i.apiUrl+"PackageDetails/"+e,"","Get","",s.getCity()).then(function(e){e.data.packageDetail?(e.data.serverDate&&(s.serverDate=parseInt(e.data.serverDate.replace("/Date(",""))),n.packageDetail=e.data.packageDetail,n.blockBookingDetails=e.data.blockBookingDetails,r(n)):o()})});return r},y=function(e){var a=s.getCity(),t=[];return _.isEmpty(e)||(l=_.uniq(_.pluck(e,"dcCity")),s.topCities=_.intersection(g,l),s.allCities=_.difference(l,s.topCities),s.cityError=_.contains(l,a)?"":a?"Service is not available in <b>"+a+"</b>, please select a city":"Please select a city",s.cityError?s.cityPopup("lg"):t=_.filter(e,function(e){return e.dcCity==a})),t},I=function(e,a,t){s.corporatePackages.internalPhleboMapping={alternateProvider:t};var r=[];return _.isEmpty(e)||_.isEmpty(s.corporatePackages.providerPincodeLocations)||_.each(e,function(e){s.corporatePackages.providerPincodeLocations.hasOwnProperty(e.dcId)&&_.pluck(s.corporatePackages.providerPincodeLocations[e.dcId],"pincode").includes(+a)&&(r.push(e),s.corporatePackages.internalPhleboMapping.hasOwnProperty("replaceByProvider")||e.dcId==t||(s.corporatePackages.internalPhleboMapping.replaceByProvider=e))}),r},h=function(e){var t=s.isUserSignedin();s.makeAjaxCalls(i.apiUrl+"UpdatePartialProfile/",{PrimaryPhoneNumber:e},"POST",t.token,s.getCity()).then(function(r){r.data.isSuccess&&(t.userDetails&&(t.userDetails.phone=e),a.getFlatProperty(t,"corpDetails.employeeDetail")&&(t.corpDetails.employeeDetail.mobileNumber=e),o.set("_mp_user",t),s.corporatePackages.employeeDetail.mobileNumber=e)})},S=function(e){if(e&&e.dcId&&e.providerRelativeUrl&&e.providerRelativeUrl.indexOf(location.origin)==-1){var a=e.dcId.indexOf("a"),t=e.dcId;a>2&&(t=e.dcId.substr(0,a));var i=r.providerWithProfile;_.contains(i,t)?e.providerRelativeUrl=location.origin+"/providerProfile/"+e.providerRelativeUrl:e.providerRelativeUrl=null}return e};return{getAHCPackage:k,getAHCPhloboProviderUnionSlots:f,getProviderSlots:v,getAhcPackagePrice:m,getPackageDetail:D,filterProvidersByCity:y,filterProvidersByPincode:I,updateUserProfile:h,filterProviderWithProfile:S,addOnBenefs:P,sendCleverTapEvent:function(e,a,t,r){window._MB_Analytics.__push({isCleverTap:!0,isGoogle:!1,name:e,dbLog:"ucp",hj:!0,googleSheet:"UCP Package Selection"==e&&r,payload:window._Site_Props.__getEventParameters({custom:a,service:t})})}}}])})}();